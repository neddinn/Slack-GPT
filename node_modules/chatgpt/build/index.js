import{createParser as b}from"eventsource-parser";import x from"expiry-map";import l from"node-fetch";import{v4 as _}from"uuid";import{remark as A}from"remark";import S from"strip-markdown";function m(h){return A().use(S).processSync(h??"").toString()}var T="accessToken",E="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36",y=class{constructor(t){this._accessTokenCache=new x(10*1e3);let{sessionToken:e,markdown:s=!0,apiBaseUrl:r="https://chat.openai.com/api",backendApiBaseUrl:o="https://chat.openai.com/backend-api",userAgent:a=E}=t;if(this._sessionToken=e,this._markdown=!!s,this._apiBaseUrl=r,this._backendApiBaseUrl=o,this._userAgent=a,!this._sessionToken)throw new Error("ChatGPT invalid session token")}async getIsAuthenticated(){try{return await this.refreshAccessToken(),!0}catch{return!1}}async ensureAuth(){return await this.refreshAccessToken()}async sendMessage(t,e={}){let{converstationId:s=_(),onProgress:r}=e,o=await this.refreshAccessToken(),a={action:"next",messages:[{id:_(),role:"user",content:{content_type:"text",parts:[t]}}],model:"text-davinci-002-render",parent_message_id:s},n=`${this._backendApiBaseUrl}/conversation`,d="";return new Promise((w,g)=>{this._fetchSSE(n,{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json","user-agent":this._userAgent},body:JSON.stringify(a),onMessage:k=>{var f,u;if(k==="[DONE]")return w(d);try{let c=JSON.parse(k).message;if(c){let i=(u=(f=c==null?void 0:c.content)==null?void 0:f.parts)==null?void 0:u[0];i&&(this._markdown||(i=m(i)),d=i,r&&r(i))}}catch(p){console.warn("fetchSSE onMessage unexpected error",p),g(p)}}}).catch(g)})}async refreshAccessToken(){let t=this._accessTokenCache.get(T);if(t)return t;try{let e=await l("https://chat.openai.com/api/auth/session",{headers:{cookie:`__Secure-next-auth.session-token=${this._sessionToken}`,"user-agent":this._userAgent}}).then(r=>r.json()),s=e==null?void 0:e.accessToken;if(!s)throw console.warn("no auth token",e),new Error("Unauthorized");return this._accessTokenCache.set(T,s),s}catch(e){throw new Error(`ChatGPT failed to refresh auth token: ${e.toString()}`)}}async _fetchSSE(t,e){let{onMessage:s,...r}=e,o=await l(t,r),a=b(n=>{n.type==="event"&&s(n.data)});o.body.on("readable",()=>{let n;for(;(n=o.body.read())!==null;)a.feed(n.toString())})}};export{y as ChatGPTAPI,m as markdownToText};
//# sourceMappingURL=index.js.map